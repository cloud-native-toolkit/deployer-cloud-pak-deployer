---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: cloud-pak-deployer-4.8.x-tse-l4-base
  annotations:
spec:
  params:
    - name: namespace
      type: string
      description: Namespace for Cloud Pak Deployer deployment
      default: "cloud-pak-deployer"
    - name: storage-class
      type: string
      description: RWX storage class needed for cp4d
      default: "ocs-storagecluster-cephfs"
    - name: cloud-pak-deployer-storage-class
      type: string
      description: |
        Choose the defined storage class for the cloud pak deployer.
        {
          "options": [
            {"text": "auto-storage","value": "auto-storage", "default": "true"},
            {"text": "ocs-storage","value": "ocs-storage"},
            {"text": "nfs-storage","value": "nfs-storage"}
          ]
        }
      default: "auto-storage"
    - name: cloud-pak-deployer-storage-type
      type: string
      description: |
        Choose the defined storage type for the cloud pak deployer.
        {
          "options": [
            {"text": "auto","value": "auto", "default": "true"},
            {"text": "ocs","value": "ocs"},
            {"text": "nfs","value": "nfs"}
          ]
        }
      default: "auto"
    - name: configure-gpu
      type: string
      description: |
        Install the NVIDIA operator and Node Feature Discovery for GPU nodes.
        {
          "options": [
            {"text": "No","value": "False", "default": "true"},
            {"text": "Yes","value": "True"}
          ]
        }
      default: "False"
    - name: ocp-client-version
      type: string
      description: Openshift client version
      default: "4.14"
    - name: cp4d-version
      type: string
      description: Cloud Pak for Data version
      default: "4.8.4"
    - name: ibm-entitlement-key
      type: string
      description: The IBM entitlement key with permissions for pulling cp4d images
      default: "false"
    - name: cpd-confirm-destroy
      type: string
      description: Should the cloud pak deployer delete components that already exist in the cluster if you don't define them? True to delete components, False to not delete components.
      default: "True"

    - name: scheduler-state
      type: string
      description: |
        Do you want to install scheduler?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: analyticsengine-state
      type: string
      description: |
        Do you want to install analytics engine?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: analyticsengine-size
      type: string
      description: |
        Choose the size of analytics engine installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: bigsql-state
      type: string
      description: |
        Do you want to install bigsql?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: ca-state
      type: string
      description: |
        Do you want to install cognos analytics?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: ca-size
      type: string
      description: |
        Choose size of cognos analytics installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: ca-instance
      type: string
      description: Choose the name of cognos analytics instance.
      default: "ca-instance"
    - name: dashboard-state
      type: string
      description: |
        Do you want to install cognos dashboards?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: datagate-state
      type: string
      description: |
        Do you want to install datagate?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: datastage-ent-state
      type: string
      description: |
        Do you want to install datastage enterprise?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: datastage-ent-plus-state
      type: string
      description: |
        Do you want to install datastage enterprise plus?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: db2-state
      type: string
      description: |
        Do you want to install db2?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: db2-size
      type: string
      description: |
        Choose size of db2 installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: db2wh-state
      type: string
      description: |
        Do you want to install db2 warehouse?
        {
          "options": [
            {"text": "False","value": "removed", "default": "true"},
            {"text": "True","value": "installed"}
          ]
        }
      default: "removed"
    - name: dmc-state
      type: string
      description: |
        Do you want to install db2 data management console?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: dods-state
      type: string
      description: |
        Do you want to install decision optimization?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: dods-size
      type: string
      description: |
        Choose size of decision optimization installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: dp-state
      type: string
      description: |
        Do you want to install data privacy?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: dp-size
      type: string
      description: |
        Choose size of data privacy installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: dpra-state
      type: string
      description: |
        Do you want to install data privacy risk assessment?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: factsheet-state
      type: string
      description: |
        Do you want to install ai factsheets?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: factsheet-size
      type: string
      description: |
        Choose size of ai factsheets installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: dv-state
      type: string
      description: |
        Do you want to install data virtualization?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: dv-size
      type: string
      description: |
        Choose size of data virtualization installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: dv-instance
      type: string
      description: Provide name of the data virtualization instance.
      default: "data-virtualization"
    - name: hadoop-state
      type: string
      description: |
        Do you want to install hadoop?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: hadoop-size
      type: string
      description: |
        Choose size of hadoop installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: mantaflow-state
      type: string
      description: |
        Do you want to install MANTA Automated Lineage?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: mantaflow-size
      type: string
      description: |
        Choose size of MANTA Automated Lineage installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small with min cpu","value": "small_mincpureq"},
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: match360-state
      type: string
      description: |
        Do you want to install match360?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: match360-size
      type: string
      description: |
        Choose size of match360 installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: match360-wkc-enabled
      type: string
      description: |
        Do you want wkc enabled for match360 installation? (only applied if component is installed)
        {
          "options": [
            {"text": "Yes","value": "true", "default": "true"},
            {"text": "No","value": "false"}
          ]
        }
      default: "true"
    - name: openpages-state
      type: string
      description: |
        Do you want to install openpages?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: rstudio-state
      type: string
      description: |
        Do you want to install rstudio?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: rstudio-size
      type: string
      description: |
        Choose size of rstudio installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: spss-state
      type: string
      description: |
        Do you want to install spss modeler?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: syntheticdata-state
      type: string
      description: |
        Do you want to install Synthetic Data Generator?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: voice-gateway-state
      type: string
      description: |
        Do you want to install voice gateway?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: voice-gateway-replicas
      type: string
      description: Provide number of voice gateway replicas.
      default: "1"
    - name: watsonx-assistant-state
      type: string
      description: |
        Do you want to install watsonx assistant.
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: watsonx-assistant-size
      type: string
      description: |
        Choose size of watsonx assistant installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: wa-instance
      type: string
      description: Choose the name of Watsonx Assistant instance.
      default: "wa-instance"
    - name: watson-discovery-state
      type: string
      description: |
        Do you want to install watson discovery?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: watson-ks-state
      type: string
      description: |
        Do you want to install watson knowledge studio?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: watson-ks-size
      type: string
      description: |
        Choose size of watson knowledge studio installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: watson-openscale-state
      type: string
      description: |
        Do you want to install watson openscale?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: watson-openscale-size
      type: string
      description: |
        Choose size of watson openscale installation. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: watson-speech-state
      type: string
      description: |
        Do you want to install watson speech?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: watson-speech-stt-size
      type: string
      description: |
        Choose size of watson speech to text. (only applied if component is installed)
        {
          "options": [
            {"text": "Extra Small","value": "xsmall", "default": "true"},
            {"text": "Small","value": "small"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "xsmall"
    - name: watson-speech-tts-size
      type: string
      description: |
        Choose size of watson text to speech. (only applied if component is installed)
        {
          "options": [
            {"text": "Extra Small","value": "xsmall", "default": "true"},
            {"text": "Small","value": "small"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "xsmall"
    - name: watsonx-ai-state
      type: string
      description: |
        Do you want to install watsonx.ai?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-google-flan-t5-xxl-state
      type: string
      description: |
        Do you want to install google-flan-t5-xxl llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-google-flan-ul2-state
      type: string
      description: |
        Do you want to install google-flan-ul2 llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-eleutherai-gpt-neox-20b-state
      type: string
      description: |
        Do you want to install eleutherai-gpt-neox-20b llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-granite-13b-chat-v1-state
      type: string
      description: |
        Do you want to install ibm-granite-13b-chat-v1 llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-granite-13b-chat-v2-state
      type: string
      description: |
        Do you want to install ibm-granite-13b-chat-v2 llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-ibm-granite-13b-instruct-v1-state
      type: string
      description: |
        Do you want to install ibm-granite-13b-instruct-v1 llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-ibm-granite-13b-instruct-v2-state
      type: string
      description: |
        Do you want to install ibm-granite-13b-instruct-v2 llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-meta-llama-llama-2-70b-chat-state
      type: string
      description: |
        Do you want to install meta-llama-llama-2-70b-chat llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-ibm-mpt-7b-instruct2-state
      type: string
      description: |
        Do you want to install ibm-mpt-7b-instruct2 llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-codellama-codellama-34b-instruct-hf-state
      type: string
      description: |
        Do you want to install codellama-codellama-34b-instruct-hf?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-elyza-japanese-llama-2-7b-instruct-state
      type: string
      description: |
        Do you want to install elyza-japanese-llama-2-7b-instruct?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-ibm-mistralai-mixtral-8x7b-instruct-v01-q-state
      type: string
      description: |
        Do you want to install ibm-mistralai-mixtral-8x7b-instruct-v01-q?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-bigscience-mt0-xxl-state
      type: string
      description: |
        Do you want to install bigscience-mt0-xxl llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-bigcode-starcoder-state
      type: string
      description: |
        Do you want to install bigcode-starcoder llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-ibm-granite-8b-japanese-state
      type: string
      description: |
        Do you want to install ibm-granite-8b-japanese llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-ibm-granite-20b-multilingual-state
      type: string
      description: |
        Do you want to install ibm-granite-20b-multilingual llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-meta-llama-llama-2-13b-chat-state
      type: string
      description: |
        Do you want to install meta-llama-llama-2-13b-chat llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: llm-google-flan-t5-xl-state
      type: string
      description: |
        Do you want to install google-flan-t5-xl llm?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: watsonx-data-state
      type: string
      description: |
        Do you want to install watsonx.data?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: wkc-state
      type: string
      description: |
        Do you want to install watson knowledge catalog?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: wkc-size
      type: string
      description: |
        Choose size of watson knowledge catalogue. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: wkc-options-core-only
      type: string
      description: |
        Do you want to install core wkc only? (only applied if wkc is installed)
        {
          "options": [
            {"text": "Yes","value": "True", "default": "true"},
            {"text": "No","value": "False"}
          ]
        }
      default: "True"
    - name: wkc-options-knowledge-graph
      type: string
      description: |
        Do you want to enable knowledge graph for wkc? (only applied if wkc is installed)
        {
          "options": [
            {"text": "No","value": "False", "default": "true"},
            {"text": "Yes","value": "True"}
          ]
        }
      default: "False"
    - name: wkc-options-enable-data-quality
      type: string
      description: |
        Do you want to enable data quality for wkc?
        {
          "options": [
            {"text": "No","value": "False", "default": "true"},
            {"text": "Yes","value": "True"}
          ]
        }
      default: "False"
    - name: wkc-options-enable-fact-sheet
      type: string
      description: |
        Do you want to enable fact sheet for wkc?
        {
          "options": [
            {"text": "No","value": "False", "default": "true"},
            {"text": "Yes","value": "True"}
          ]
        }
      default: "False"
    - name: watsonx-orchestrate-state
      type: string
      description: |
        Do you want to install watsonx orchestrate?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: planning-analytics-state
      type: string
      description: |
        Do you want to install planning analytics?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: replication-state
      type: string
      description: |
        Do you want to install data replication?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: replication-size
      type: string
      description: |
        Choose size of data replication. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: watsonx-governance-state
      type: string
      description: |
        Do you want to install watsonx governance?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: watsonx-gov-installType
      type: string
      description: |
        Specify which watsonx.governance entitlement you purchased.
        {
          "options": [
            {"text": "Both Model Management and Risk & Compliance Foundation entitlements","value": "all", "default": "true"},
            {"text": "Just Model Management entitlement","value": "mm"},
            {"text": "Just Risk and Compliance Foundation entitlement","value": "rcf"}
          ]
        }
      default: "all"
    - name: watsonx-gov-enableFactsheet
      type: string
      description: |
        Do you want Factsheets enabled for watsonx governance installation? (only applied if component is installed)
        {
          "options": [
            {"text": "Yes","value": "true", "default": "true"},
            {"text": "No","value": "false"}
          ]
        }
      default: "true"
    - name: watsonx-gov-enableOpenpages
      type: string
      description: |
        Do you want OpenPages enabled for watsonx governance installation? (only applied if component is installed)
        {
          "options": [
            {"text": "Yes","value": "true", "default": "true"},
            {"text": "No","value": "false"}
          ]
        }
      default: "true"
    - name: watsonx-gov-enableOpenscale
      type: string
      description: |
        Do you want OpenScale enabled for watsonx governance installation? (only applied if component is installed)
        {
          "options": [
            {"text": "Yes","value": "true", "default": "true"},
            {"text": "No","value": "false"}
          ]
        }
      default: "true"
    - name: wml-state
      type: string
      description: |
        Do you want to install watson machine learning?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: wml-size
      type: string
      description: |
        Choose size of watson machine learning. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: wml-accelerator-state
      type: string
      description: |
        Do you want to install watson machine learning accelerator?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    - name: wml-accelerator-size
      type: string
      description: |
        Choose size of watson machine learning accelerator. (only applied if component is installed)
        {
          "options": [
            {"text": "Small","value": "small", "default": "true"},
            {"text": "Medium","value": "medium"},
            {"text": "Large","value": "large"}
          ]
        }
      default: "small"
    - name: wml-accelerator-replicas
      type: string
      description: Provide number of wml accelerator replicas.
      default: "1"
    - name: ws-state
      type: string
      description: |
        Do you want to install watson studio?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed"}
          ]
        }
      default: "removed"
    # IMPORTANT: WS PIPELINES CANNOT BE INSTALLED IN A CLUSTER THAT ALSO HAS OPENSHIFT PIPELINES.
    # BECAUSE OPENSHIFT PIPELINES IS NECESSARY FOR DEPLOYER, WS PIPELINES CANNOT BE INSTALLED
    # - name: ws-pipelines-state
    #   type: string
    #   description: |
    #     Do you want to install watson studio pipelines?
    #     {
    #       "options": [
    #         {"text": "No","value": "removed", "default": "true"},
    #         {"text": "Yes","value": "installed" }
    #       ]
    #     }
    #   default: "removed"
    - name: ws-runtimes-state
      type: string
      description: |
        Do you want to install watson studio runtimes?
        {
          "options": [
            {"text": "No","value": "removed", "default": "true"},
            {"text": "Yes","value": "installed" }
          ]
        }
      default: "removed"
  finally:
    - name: update-configmap-failure
      when:
        - input: $(tasks.run-the-deployer.status)
          operator: notin
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |
            oc patch configmap/pipeline-output -p '{"data":{"Status":"Pipeline run failed. See Pipeline run for more details and consider running the pipeline again."}}'
    - name: update-configmap-success
      when:
        - input: $(tasks.run-the-deployer.status)
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |
            cpd_route=$(oc get route cpd -n cpd --template='{{ .spec.host }}')
            echo "Console Route: $cpd_route"
            initial_admin_password=$(oc get secret admin-user-details -n cpd -o jsonpath='{.data.initial_admin_password}' | base64 -d)
            echo "Username: admin"
            echo "Password: $initial_admin_password"

            oc patch configmap/pipeline-output -p "{\"data\":{\"Status\":\"Pipeline run Successful\",\"CP4D-Console-Route\":\"${cpd_route}\",\"CP4D-Initial-Admin-Username\":\"admin\",\"CP4D-Initial-Admin-Password\":\"${initial_admin_password}\"}}"
  tasks:
    - name: add-namespace
      retries: 3
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |
            oc apply -f - <<EOF 
            apiVersion: v1
            kind: Namespace
            metadata:
              creationTimestamp: null
              name: $(params.namespace)
            EOF
    - name: add-sa
      retries: 3
      taskRef:
        kind: Task
        name: ibm-pak
      runAfter:
        - add-namespace
      params:
        - name: SCRIPT
          value: |
            oc apply -f - <<EOF 
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              name: cloud-pak-deployer-sa
              namespace: $(params.namespace)
            EOF
    - name: add-sa-permissions
      retries: 3
      taskRef:
        kind: Task
        name: ibm-pak
      runAfter:
        - add-sa
      params:
        - name: SCRIPT
          value: |
            oc apply -f - <<EOF 
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              name: system:openshift:scc:privileged
              namespace: $(params.namespace)
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: ClusterRole
              name: system:openshift:scc:privileged
            subjects:
            - kind: ServiceAccount
              name: cloud-pak-deployer-sa
              namespace: $(params.namespace)
            EOF
    - name: bind-sa-permissions
      retries: 3
      taskRef:
        kind: Task
        name: ibm-pak
      runAfter:
        - add-sa-permissions
      params:
        - name: SCRIPT
          value: |
            oc apply -f - <<EOF 
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRoleBinding
            metadata:
              name: cloud-pak-deployer-cluster-admin
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: ClusterRole
              name: cluster-admin
            subjects:
            - kind: ServiceAccount
              name: cloud-pak-deployer-sa
              namespace: $(params.namespace)
            EOF
    - name: create-pvc
      retries: 3
      taskRef:
        kind: Task
        name: ibm-pak
      runAfter:
        - bind-sa-permissions
      params:
        - name: SCRIPT
          value: |
            oc apply -f - <<EOF
            apiVersion: v1 
            kind: PersistentVolumeClaim
            metadata:
              name: cloud-pak-deployer-status
              namespace: $(params.namespace)
            spec:
              accessModes:
              - ReadWriteMany
              storageClassName: $(params.storage-class)
              resources:
                requests:
                  storage: 10Gi
            EOF
    - name: get-tz-ibm-entitlement-key
      retries: 3
      params:
        - name: KEY_ID
          value: 968d7819-f2c5-7b67-c420-3c6bfd51521e
        - name: SECRETS_MANAGER_ENDPOINT_URL
          value: >-
            https://afa20521-cd75-4864-843f-e59fd0ffd49d.us-south.secrets-manager.appdomain.cloud
      taskRef:
        kind: Task
        name: ibmcloud-secrets-manager-get
      runAfter:
        - create-pvc
    - name: assign-ibm-entitlement-key
      retries: 3
      params:
        - name: ibm-entitlement-key
          value: "$(params.ibm-entitlement-key)"
        - name: tz-ibm-entitlement-key
          value: "$(tasks.get-tz-ibm-entitlement-key.results.secret-value)"
      taskSpec:
        params:
          - name: ibm-entitlement-key
            type: string
            description: user provided ibm-entitlement-key
          - name: tz-ibm-entitlement-key
            type: string
            description: user provided ibm-entitlement-key
        results:
          - name: key
            description: The key to use for the secret
            type: string
        steps:
          - image: podman
            securityContext:
              capabilities:
                add: ["SETFCAP"]
            script: |
              if [ "$(params.ibm-entitlement-key)" != "false" ]; then
                echo "user provided key - $(params.ibm-entitlement-key)"
                printf "$(params.ibm-entitlement-key)" | tee $(results.key.path)

                echo "testing key for cp.icr.io"
                podman login cp.icr.io --username cp --password $(params.ibm-entitlement-key)
              else
                echo "techzone key - $(params.tz-ibm-entitlement-key)"
                printf "$(params.tz-ibm-entitlement-key)" | tee $(results.key.path)
              fi
      runAfter:
        - get-tz-ibm-entitlement-key
    - name: create-entitlement-key-secret
      taskRef:
        kind: Task
        name: ibm-pak
      runAfter:
        - assign-ibm-entitlement-key
      retries: 3
      params:
        - name: SCRIPT
          value: |
            oc apply -f - <<EOF
            apiVersion: v1
            kind: Secret
            metadata:
              name: cloud-pak-entitlement-key
              namespace: $(params.namespace)
            type: Opaque
            stringData:
              cp-entitlement-key: |
                $(tasks.assign-ibm-entitlement-key.results.key)
            EOF
    - name: configure-cloud-paks-services
      runAfter:
        - create-entitlement-key-secret
      retries: 3
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |
            oc apply -f - <<EOF
            apiVersion: v1
            kind: ConfigMap
            metadata:
              name: cloud-pak-deployer-config
              namespace: $(params.namespace)
            data:
              cpd-config.yaml: |
                global_config:
                  environment_name: demo
                  cloud_platform: existing-ocp
                  confirm_destroy: $(params.cpd-confirm-destroy)

                openshift:
                - name: cpd-demo
                  ocp_version: '$(params.ocp-client-version)'
                  cluster_name: cpd-demo
                  domain_name: example.com
                  gpu:
                    install: $(params.configure-gpu)
                  openshift_storage:
                  - storage_name: $(params.cloud-pak-deployer-storage-class)
                    storage_type: $(params.cloud-pak-deployer-storage-type)

                #
                # All tested cartridges. To install, change the "state" property to "installed". To uninstall, change the state
                # to "removed" or comment out the entire cartridge. Make sure that the "-" and properties are aligned with the lite
                # cartridge; the "-" is at position 3 and the property starts at position 5.
                #
                # If a cartridge has dependencies and you want to install it, you must ensure that the dependent cartridge is also
                # installed.
                #

                cp4d:
                - project: cpd
                  cp4d_version: $(params.cp4d-version)
                  use_fs_iam: False
                  sequential_install: False
                  accept_licenses: True
                  cartridges:
                  - name: cp-foundation
                    license_service:
                      state: disabled
                      threads_per_core: 2

                  - name: lite

                  - name: scheduler 
                    state: $(params.scheduler-state)

                  - name: analyticsengine
                    description: Analytics Engine Powered by Apache Spark 
                    size: $(params.analyticsengine-size) 
                    state: $(params.analyticsengine-state)

                  - name: bigsql
                    description: Db2 Big SQL
                    state: $(params.bigsql-state)

                  - name: ca
                    description: Cognos Analytics
                    size: $(params.ca-size)
                    instances:
                    - name: $(params.ca-instance)
                      metastore_ref: ca-metastore
                    state: $(params.ca-state)

                  - name: dashboard
                    description: Cognos Dashboards
                    state: $(params.dashboard-state)

                  - name: datagate
                    description: Db2 Data Gate
                    state: $(params.datagate-state)

                  - name: datastage-ent
                    description: DataStage Enterprise
                    state: $(params.datastage-ent-state)

                  - name: datastage-ent-plus
                    description: DataStage Enterprise Plus
                    state: $(params.datastage-ent-plus-state)
                    # instances:
                    #   - name: ds-instance
                    #     # Optional settings
                    #     description: "datastage ds-instance"
                    #     size: medium
                    #     storage_class: efs-nfs-client
                    #     storage_size_gb: 60
                    #     # Custom Scale options
                    #     scale_px_runtime:
                    #       replicas: 2
                    #       cpu_request: 500m
                    #       cpu_limit: 2
                    #       memory_request: 2Gi
                    #       memory_limit: 4Gi
                    #     scale_px_compute:
                    #       replicas: 2
                    #       cpu_request: 1
                    #       cpu_limit: 3
                    #       memory_request: 4Gi
                    #       memory_limit: 12Gi 

                  - name: db2
                    description: Db2 OLTP
                    size: $(params.db2-size)
                    # instances:
                    # - name: Db2
                    #   metadata_size_gb: 20
                    #   data_size_gb: 20
                    #   backup_size_gb: 20  
                    #   transactionlog_size_gb: 20
                    state: $(params.db2-state)

                  - name: db2wh
                    description: Db2 Warehouse
                    state: $(params.db2wh-state)

                  - name: dmc
                    description: Db2 Data Management Console
                    instances:
                    - name: data-management-console
                    state: $(params.dmc-state)

                  - name: dods
                    description: Decision Optimization
                    size: $(params.dods-size)
                    state: $(params.dods-state)

                  - name: dp
                    description: Data Privacy
                    size: $(params.dp-size)
                    state: $(params.dp-state)

                  - name: dpra
                    description: Data Privacy Risk Assessment
                    state: $(params.dpra-state)

                  - name: dv
                    description: Data Virtualization
                    size: $(params.dv-size)
                    instances:
                    - name: $(params.dv-instance)
                    state: $(params.dv-state)

                  # Please note that for EDB Postgress, a secret edb-postgres-license-key must be created in the vault
                  # before deploying
                  - name: edb_cp4d
                    description: EDB Postgres
                    state: removed
                    instances:
                      - name: instance1
                        version: "15.4"
                        #type: Standard
                        #members: 1
                        #size_gb: 50
                        #resource_request_cpu: 1
                        #resource_request_memory: 4Gi
                        #resource_limit_cpu: 1
                        #resource_limit_memory: 4Gi

                  - name: factsheet
                    description: AI Factsheets
                    size: $(params.factsheet-size)
                    state: $(params.factsheet-state)

                  - name: hadoop
                    description: Execution Engine for Apache Hadoop
                    size: $(params.hadoop-size)
                    state: $(params.hadoop-state)

                  - name: mantaflow
                    description: MANTA Automated Lineage
                    size: $(params.mantaflow-size)
                    state: $(params.mantaflow-state)

                  - name: match360
                    description: IBM Match 360
                    size: $(params.match360-size)
                    wkc_enabled: $(params.match360-wkc-enabled)
                    state: $(params.match360-state)

                  - name: openpages
                    description: OpenPages
                    state: $(params.openpages-state)

                  # For Planning Analytics, the case version is needed due to defect in olm utils
                  - name: planning-analytics
                    description: Planning Analytics
                    state: $(params.planning-analytics-state)

                  - name: replication
                    description: Data Replication
                    license: IDRC
                    size: $(params.replication-size)
                    state: $(params.replication-state)

                  - name: rstudio
                    description: RStudio Server with R 3.6
                    size: $(params.rstudio-size)
                    state: $(params.rstudio-state)

                  - name: spss
                    description: SPSS Modeler
                    state: $(params.spss-state)

                  - name: syntheticdata
                    description: Synthetic Data Generator
                    state: $(params.syntheticdata-state)

                  - name: voice-gateway
                    description: Voice Gateway
                    replicas: $(params.voice-gateway-replicas)
                    state: $(params.voice-gateway-state)

                  - name: watson-assistant
                    description: Watsonx Assistant
                    size: $(params.watsonx-assistant-size)
                    # noobaa_account_secret: noobaa-admin
                    # noobaa_cert_secret: noobaa-s3-serving-cert
                    state: $(params.watsonx-assistant-state)
                    instances:
                    - name: $(params.wa-instance)
                      description: "Watsonx Assistant instance"

                  - name: watson-discovery
                    description: Watson Discovery
                    # noobaa_account_secret: noobaa-admin
                    # noobaa_cert_secret: noobaa-s3-serving-cert
                    state: $(params.watson-discovery-state)

                  # For Watson Knowledge Studio, the case version is needed due to defect in olm utils
                  - name: watson-ks
                    description: Watson Knowledge Studio
                    size: $(params.watson-ks-size)
                    # noobaa_account_secret: noobaa-admin
                    # noobaa_cert_secret: noobaa-s3-serving-cert
                    state: $(params.watson-ks-state)

                  - name: watson-openscale
                    description: Watson OpenScale
                    size: $(params.watson-openscale-size)
                    state: $(params.watson-openscale-state)

                  - name: watson-speech
                    description: Watson Speech (STT and TTS)
                    stt_size: $(params.watson-speech-stt-size)
                    tts_size: $(params.watson-speech-tts-size)
                    state: $(params.watson-speech-state)

                  - name: watsonx_ai
                    description: watsonx.ai
                    state: $(params.watsonx-ai-state)
                    models:
                    - model_id: google-flan-t5-xxl
                      state: $(params.llm-google-flan-t5-xxl-state)
                    - model_id: google-flan-ul2
                      state: $(params.llm-google-flan-ul2-state)
                    - model_id: google-flan-t5-xl
                      state: $(params.llm-google-flan-t5-xl-state)
                    - model_id: eleutherai-gpt-neox-20b
                      state: $(params.llm-eleutherai-gpt-neox-20b-state)
                    - model_id: ibm-granite-13b-chat-v1
                      state: $(params.llm-granite-13b-chat-v1-state)
                    - model_id: ibm-granite-13b-chat-v2
                      state: $(params.llm-granite-13b-chat-v2-state)
                    - model_id: ibm-granite-13b-instruct-v1
                      state: $(params.llm-ibm-granite-13b-instruct-v1-state)
                    - model_id: ibm-granite-13b-instruct-v2
                      state: $(params.llm-ibm-granite-13b-instruct-v2-state)
                    - model_id: ibm-granite-8b-japanese
                      state: $(params.llm-ibm-granite-8b-japanese-state)
                    - model_id: ibm-granite-20b-multilingual
                      state: $(params.llm-ibm-granite-20b-multilingual-state)
                    - model_id: meta-llama-llama-2-70b-chat
                      state: $(params.llm-meta-llama-llama-2-70b-chat-state)
                    - model_id: meta-llama-llama-2-13b-chat
                      state: $(params.llm-meta-llama-llama-2-13b-chat-state)
                    - model_id: ibm-mpt-7b-instruct2
                      state: $(params.llm-ibm-mpt-7b-instruct2-state)
                    - model_id: bigscience-mt0-xxl
                      state: $(params.llm-bigscience-mt0-xxl-state)
                    - model_id: bigcode-starcoder
                      state: $(params.llm-bigcode-starcoder-state)
                    - model_id: codellama-codellama-34b-instruct-hf
                      state: $(params.llm-codellama-codellama-34b-instruct-hf-state)
                    - model_id: elyza-japanese-llama-2-7b-instruct
                      state: $(params.llm-elyza-japanese-llama-2-7b-instruct-state)
                    - model_id: ibm-mistralai-mixtral-8x7b-instruct-v01-q
                      state: $(params.llm-ibm-mistralai-mixtral-8x7b-instruct-v01-q-state)

                  - name: watsonx_data
                    description: watsonx.data
                    state: $(params.watsonx-data-state)

                  - name: watsonx_governance
                    description: watsonx.governance
                    state: $(params.watsonx-governance-state)
                    installation_options:
                      installType: $(params.watsonx-gov-installType)
                      enableFactsheet: $(params.watsonx-gov-enableFactsheet)
                      enableOpenpages: $(params.watsonx-gov-enableOpenpages)
                      enableOpenscale: $(params.watsonx-gov-enableOpenscale)
                  
                  - name: watsonx_orchestrate
                    description: watsonx.orchestrate
                    state: $(params.watsonx-orchestrate-state)

                  - name: wkc
                    description: Watson Knowledge Catalog
                    size: $(params.wkc-size)
                    state: $(params.wkc-state)
                    installation_options:
                      install_wkc_core_only: $(params.wkc-options-core-only)
                      enableKnowledgeGraph: $(params.wkc-options-knowledge-graph)
                      enableDataQuality: $(params.wkc-options-enable-data-quality)
                      enableFactSheet: $(params.wkc-options-enable-fact-sheet)

                  - name: wml
                    description: Watson Machine Learning
                    size: $(params.wml-size)
                    state: $(params.wml-state)

                  - name: wml-accelerator
                    description: Watson Machine Learning Accelerator
                    replicas: $(params.wml-accelerator-replicas)
                    size: $(params.wml-accelerator-size)
                    state: $(params.wml-accelerator-state)

                  - name: ws
                    description: Watson Studio
                    state: $(params.ws-state)

                  - name: ws-pipelines
                    description: Watson Studio Pipelines
                    state: removed
                  
                  - name: ws-runtimes
                    description: Watson Studio Runtimes
                    runtimes:
                    - ibm-cpd-ws-runtime-py39
                    - ibm-cpd-ws-runtime-222-py
                    - ibm-cpd-ws-runtime-py39gpu
                    - ibm-cpd-ws-runtime-222-pygpu
                    - ibm-cpd-ws-runtime-231-pygpu
                    - ibm-cpd-ws-runtime-r36
                    - ibm-cpd-ws-runtime-222-r
                    - ibm-cpd-ws-runtime-231-r
                    state: $(params.ws-runtimes-state)

                  # Cartridges where extra work is needed (will not install automatically)

                  # Product Master requires set up of the Db2 instance secret before install
                  - name: productmaster
                    description: Product Master
                    size: small  
                    state: removed 
            EOF
    - name: run-the-deployer
      taskRef:
        kind: Task
        name: ibm-pak
      timeout: 6h0m0s
      retries: 3
      runAfter:
        - configure-cloud-paks-services
      params:
        - name: SCRIPT
          value: |
            oc delete job cloud-pak-deployer -n $(params.namespace) --ignore-not-found

            sleep 20

            oc apply -f - <<EOF
            apiVersion: batch/v1
            kind: Job
            metadata:
              labels:
                app: cloud-pak-deployer
              name: cloud-pak-deployer
              namespace: $(params.namespace)
            spec:
              parallelism: 1
              completions: 1
              backoffLimit: 0
              template:
                metadata:
                  name: cloud-pak-deployer
                  labels:
                    app: cloud-pak-deployer
                spec:
                  containers:
                  - name: cloud-pak-deployer
                    image: quay.io/cloud-pak-deployer/cloud-pak-deployer:latest
                    imagePullPolicy: Always
                    terminationMessagePath: /dev/termination-log
                    terminationMessagePolicy: File
                    env:
                    - name: CONFIG_DIR
                      value: /Data/cpd-config
                    - name: STATUS_DIR
                      value: /Data/cpd-status
                    - name: CP_ENTITLEMENT_KEY
                      valueFrom:
                        secretKeyRef:
                          key: cp-entitlement-key
                          name: cloud-pak-entitlement-key
                    volumeMounts:
                    - name: config-volume
                      mountPath: /Data/cpd-config/config
                    - name: status-volume
                      mountPath: /Data/cpd-status
                    command: ["/bin/sh","-xc"]
                    args: 
                      - /cloud-pak-deployer/cp-deploy.sh env apply -v
                  restartPolicy: Never
                  securityContext:
                    runAsUser: 0
                  serviceAccountName: cloud-pak-deployer-sa
                  volumes:
                  - name: config-volume
                    configMap:
                      name: cloud-pak-deployer-config
                  - name: status-volume
                    persistentVolumeClaim:
                      claimName: cloud-pak-deployer-status
            EOF

            sleep 20

            while true
            do
              is_complete=$(oc get -n $(params.namespace) job/cloud-pak-deployer -o yaml | yq '.status.conditions.[] | select(.type == "Complete") | contains({"status": "'True'"})')
              if [[ $is_complete != "true" ]]; then
                echo "Waiting for job to be Complete."
              else
                echo "Cloud Pak Deployer job is Complete."
                break
              fi

              did_fail=$(oc get -n $(params.namespace) job/cloud-pak-deployer -o yaml | yq '.status.conditions.[] | select(.type == "Failed") | contains({"status": "'True'"})')
              if [[ $did_fail == "true" ]]; then
                echo "Cloud Pak Deployer job failed."
                echo $(oc get -n $(params.namespace) job/cloud-pak-deployer -o yaml | yq '.status.conditions.[] | select(.type == "Failed") | .reason')
                echo $(oc get -n $(params.namespace) job/cloud-pak-deployer -o yaml | yq '.status.conditions.[] | select(.type == "Failed") | .message')
                exit 68
              fi
              
              sleep 10
            done
